---
import Layout from "../../layouts/Layout.astro";
import Section from "../../components/Section.astro";
---

<Layout>
  <Section background="light">
    <header class="mb-4 text-center">
      <h1
        class="font-handjet text-brown-header mb-4 text-4xl font-bold md:text-6xl"
      >
        Local thermostat
      </h1>
      <p class="mx-auto max-w-2xl">
          The example below shows a page with two LocalLiveView components rendered next to each other.
          ThermostatLive handles onclick events, which update the temperature.
          ClockLive uses the popcorn runtime's internal timer to update the clock every 1 second.
      </p>
    </header>
    <style>
         
     </style>
     <div class="bg-brown-100 relative w-1/2 rounded-lg border p-4" >
         <div data-pop-view="ThermostatLive" class="text-light-20 items-center gap-2"></div>
         <div data-pop-view="ClockLive" class="text-light-20 flex items-center gap-2"></div>
     </div>
  </Section>
</Layout>

<style is:global>
.local_thermostat {
    font-size: 1.5em;
    font-family: sans-serif;
    max-width: 800px;
    padding: 1em;
    background-color: #161616;
    color: #fcfcfc;
}
.ghost-button {
  background-color: transparent;
  color: white;
  border: 2px solid white;
  padding: 2px 5px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease-in-out;
}
.ghost-button:hover {
  background-color: white;
  color: #1a1a1a;
  box-shadow: 0 4px 15px rgba(255, 255, 255, 0.4);
}
.ghost-button:disabled {
  color: gray;
  border: 2px solid gray;
}
.ghost-button:disabled:hover {
  color: gray;
  background-color: transparent;
  box-shadow: none;
  cursor: auto;
}
</style>

<script>
  var events = [
      {js_event: "click", pop_event: "pop-click"},
      {js_event: "keydown", pop_event: "pop-keydown"},
      {js_event: "submit", pop_event: "pop-submit"},
      {js_event: "input", pop_event: "pop-change"}
  ]
  
  var focused_el = document.activeElement;
  
  async function setup() {
    const popcorn = await Popcorn.init({
      debug: true,
      bundlePath: "../wasm/local_thermostat.avm",
      wasmDir: "/wasm/"
    })
    
    var afterRenderBind = async (renderEvent) => {
      var view = renderEvent.detail.view
      var view_element = find_element(renderEvent.detail.view)
      focused_el.focus()
      events.forEach(({js_event: event, pop_event: pop_event}) => {
        const elements = view_element.querySelectorAll("[" + pop_event + "]");
        elements.forEach(el => {
          if (el.hasAttribute(pop_event)) {
            console.log("added event handler")
            el.addEventListener(event, async (e) => {
              focused_el = document.activeElement;
              var value
              if(el instanceof HTMLFormElement){
                e.preventDefault();
                const inputs = el.querySelectorAll('input');
                const inputsArray = Array.from(inputs)
                value = inputsArray.reduce((acc, input) => {
                  acc[input.name] = input.value;
                  return acc;
                }, {});
              } else if (el.hasAttribute(value))  {
                value = el.value;
              }
              try {
                const { data, durationMs } = await popcorn.call({ "view": view, "event": pop_event, 
                  "payload": {"event": el.getAttribute(pop_event), "value": value} }, {
                  timeoutMs: 10_000,
                });
              } catch (error) {
                console.log(error)
              }
            });
          }
        });
      })
    }
    document.addEventListener("popRender", afterRenderBind);
    const { data, durationMs } = await popcorn.call({ "views": find_predefined_views()}, {
      timeoutMs: 10_000,
    });
  }
  
  // TODO this is a mock for heex templating inside index.html file
  function find_predefined_views() {
    let elements = document.querySelectorAll('[data-pop-view]');
    elements = Array.from(elements)
    return elements.map(el => el.getAttribute("data-pop-view"))
  }
  
  function find_view(element) {
    while(element) {
      if(element.hasAttribute("data-pop-view")) {
          return element.getAttribute("data-pop-view")
      }
      element = element.parentElement
    }
    return null
  }
  
  function find_element(view) {
    let elements = document.querySelectorAll('[data-pop-view]');
    elements = Array.from(elements)
    const found = elements.find((element) => element.getAttribute("data-pop-view") == view);
    return found
  }

  document.addEventListener("DOMContentLoaded", setup);
  document.addEventListener("astro:page-load", setup);
</script>
